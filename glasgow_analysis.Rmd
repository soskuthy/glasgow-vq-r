---
title: Analyses for `Voice quality and coda /r/ in Glasgow English in the early 20th
  century'
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

This R-markdown file presents all analyses for our paper titled "Voice quality and coda /r/ in Glasgow English in the early 20th century". The analyses are presented in the same order as they are in the paper, and the section numbering also follows our paper (which means that it actually starts at 4.1, which is the first results section in the paper). Note that our publication plots are created in a separate file called "glasgow_plots.Rmd".

We start by importing all relevant libraries and the data. The details of the data processing (e.g. exclusion of outliers) are shown in a separate file titled *data_prep.Rmd*.

Let's import the data and relevant libraries first. Note that we have saved our statistical models as RDS files, which allows the user to save time by not having to refit them (some of our generalised additive mixed models may take between 10 minutes to an hour to fit). The user has the option of re-fitting all models by changing the value of the *refit_please* variable to TRUE below.

```{r}
library(lme4)
library(mgcv)
library(itsadug)
library(rms)
library(tidyverse)
library(stringr)
library(effects)
library(here)
library(afex)



refit_please <- F # please don't refit all the models - just load them from RDS files

# vowel data
vowels <- read_csv("data/vowels.csv")
# formatting for mixed effects models
vowels$Speaker <- as.factor(vowels$Speaker)
vowels$Target.orthography <- as.factor(vowels$Target.orthography)
vowels$vowel <- as.factor(vowels$vowel)
vowels$decade <- ifelse(vowels$decade=="00", 2000, as.numeric(vowels$decade) + 1900)
vowels$decade.fact <- factor(vowels$decade.fact, levels=c("70","80","90","00"))


# /r/ data

R <- read_csv("data/R.csv") # F/M confuse read_csv...
coltyps <- spec(R)
coltyps$cols$gender <- col_character()
# and again!
R <- read_csv("data/R.csv", col_types=coltyps)

# some changes to variables to make them work with GAMMs
R <- R %>%
  mutate(stress = as.ordered(stress),
         start.event = (measurement.no==0),
         foll.broad.f3 = as.factor(foll.broad.f3),
         speaker = as.factor(speaker),
         word = as.factor(word))
contrasts(R$stress) <- "contr.treatment"

# separate data sets for males and females
R.m <- R %>%
  filter(gender=="M")
R.f <- R %>%
  filter(gender=="F")

# setting up variables for analysis via GAMMs
R$trans.broad <- recode(R$trans, wa="a")
R$trans.broad.fact <- as.ordered(R$trans.broad)
contrasts(R$trans.broad.fact) <- "contr.treatment"
R$gender.ordered <- as.ordered(R$gender)
contrasts(R$gender.ordered) <- "contr.treatment"


# auditory R data -- create data set with unique realisations
R.aud <- R[!(R$trans %in% c("", "?r")) & R$measurement.no==0,]
# only a few weakened approximants, so fold these into other categories
R.aud <- R %>%
  filter(!(trans %in% c("", "?r")), 
         !is.na(trans),
         measurement.no==0) %>%
  mutate(trans.broad=recode(trans, wa="a"),
         gender=recode(gender, M="male", `F`="female"))

# auditory voice quality data
# getting f3 avgs
avg.f3 <- unique(select(R, speaker, avg.f3))
# reading & formatting data
R.vq <- read_csv("data/auditoryvq.csv") %>%
  rename(speaker="speaker code",
         advanced.tip.blade="advanced tip/blade",
         tongue.body.height="tongue body height",
         tongue.body.front.backness="tongue body front-backness") %>%
  # join with avg.f3!
  inner_join(avg.f3, by="speaker") %>%
  mutate(gender=as.factor(ifelse(!is.na(str_match(speaker, "-m0")), "male", "female")),
         decade=unlist(substr(speaker, 1, 2)),
         decade=as.numeric(recode(decade, `00`="100")) + 1900)

```

# 4.1: Changes to coda /r/ -- Take 1: Acoustic results

## Males without baseline control

Analysing males first, not controlling for baseline F3. Fitting three models:

- model without AR for estimating rho (so that autocorrelation can be handled correctly)
- full model with AR
- nested model with AR (rho from full model)

Model summary for male GAMM in 4.1 is in this code chunk.

```{r}
if (refit_please) {
  # model without AR
  system.time(
    R.m.mod.no.AR <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m)
  )
  # saveRDS(R.m.mod.no.AR, "models/R.m.mod.no.AR")
  
  # extracting empirical value of autocorrelation at lag 1
  R.m.rho <- start_value_rho(R.m.mod.no.AR)
  
  # full model with AR
  system.time(
    R.m.mod.AR <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
  # saveRDS(R.m.mod.AR, "models/R.m.mod.AR")
  
  # nested model with AR
  system.time(
    R.m.mod.AR.min.decade <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          #s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
# saveRDS(R.m.mod.AR.min.decade, "models/R.m.mod.AR.min.decade")
}

R.m.mod.AR <- readRDS("models/R.m.mod.AR")
R.m.mod.AR.min.decade <- readRDS("models/R.m.mod.AR.min.decade")

summary(R.m.mod.AR)

compareML(R.m.mod.AR, R.m.mod.AR.min.decade) # significant overall effect of decade
```

Further questions (only first two of these discussed in paper):

- overall effect of stress?
- significant change in shape?
- do unstressed / stressed syllables show different changes?
  - different shape change?
  - different overall change?

```{r}
if (refit_please) {

  # overall stress?

  system.time(
    R.m.mod.AR.min.stress <- bam(f3 ~ #stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          #s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
  # saveRDS(R.m.mod.AR.min.stress, "models/R.m.mod.AR.min.stress")

  # shape change?

  system.time(
    R.m.mod.AR.min.decade.shape <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
  # saveRDS(R.m.mod.AR.min.decade.shape, "models/R.m.mod.AR.min.decade.shape")

  # overall stress x decade?

  system.time(
    R.m.mod.AR.min.decade.stress <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
  # saveRDS(R.m.mod.AR.min.decade.stress, "models/R.m.mod.AR.min.decade.stress")
  
  # shape stress x decade?
  
  system.time(
    R.m.mod.AR.min.decade.stress.shape <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
  # saveRDS(R.m.mod.AR.min.decade.stress.shape, "models/R.m.mod.AR.min.decade.stress.shape")
}
  

R.m.mod.AR.min.stress <- readRDS("models/R.m.mod.AR.min.stress")
R.m.mod.AR.min.decade.shape <- readRDS("models/R.m.mod.AR.min.decade.shape")
R.m.mod.AR.min.decade.stress <- readRDS("models/R.m.mod.AR.min.decade.stress")
R.m.mod.AR.min.decade.stress.shape <- readRDS("models/R.m.mod.AR.min.decade.stress.shape")
# overall stress?
compareML(R.m.mod.AR, R.m.mod.AR.min.stress, suggest.report=T) # non-sig
# shape change?
compareML(R.m.mod.AR, R.m.mod.AR.min.decade.shape, suggest.report=T) # non-sig
# overall stress x decade?
compareML(R.m.mod.AR, R.m.mod.AR.min.decade.stress, suggest.report=T) # non-sig
# shape stress x decade?
compareML(R.m.mod.AR, R.m.mod.AR.min.decade.stress.shape) # non-sig
```

## Females without baseline control

Analysing females, not controlling for baseline F3. Fitting three models:

- model without AR for estimating rho (so that autocorrelation can be handled correctly)
- full model with AR
- nested model with AR (rho from full model)

Model summary for female GAMM in 4.1 is in this code chunk.

```{r}
if (refit_please) {
  # model without AR
  system.time(
    R.f.mod.no.AR <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f)
  )
  # saveRDS(R.f.mod.no.AR, "models/R.f.mod.no.AR")
  
  # extracting empirical value of autocorrelation at lag 1
  R.f.rho <- start_value_rho(R.f.mod.no.AR)
  
  # full model with AR
  system.time(
    R.f.mod.AR <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR, "models/R.f.mod.AR")
  
  
  
  # nested model with AR
  system.time(
    R.f.mod.AR.min.decade <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          #s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR.min.decade, "models/R.f.mod.AR.min.decade")
}

R.f.mod.AR <- readRDS("models/R.f.mod.AR")
R.f.mod.AR.min.decade <- readRDS("models/R.f.mod.AR.min.decade")

summary(R.f.mod.AR)

compareML(R.f.mod.AR, R.f.mod.AR.min.decade) # significant overall effect of decade
```

Further questions (only first two of these discussed in paper):

- overall effect of stress?
- significant change in shape?
- do unstressed / stressed syllables show different changes?
  - different shape change?
  - different overall change?

```{r}
if (refit_please) {

  # overall stress?

  system.time(
    R.f.mod.AR.min.stress <- bam(f3 ~ #stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          #s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR.min.stress, "models/R.f.mod.AR.min.stress")

  # shape change?

  system.time(
    R.f.mod.AR.min.decade.shape <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR.min.decade.shape, "models/R.f.mod.AR.min.decade.shape")

  # overall stress x decade?

  system.time(
    R.f.mod.AR.min.decade.stress <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR.min.decade.stress, "models/R.f.mod.AR.min.decade.stress")
  
  # shape stress x decade?
  
  system.time(
    R.f.mod.AR.min.decade.stress.shape <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR.min.decade.stress.shape, "models/R.f.mod.AR.min.decade.stress.shape")
}
  

R.f.mod.AR.min.stress <- readRDS("models/R.f.mod.AR.min.stress")
R.f.mod.AR.min.decade.shape <- readRDS("models/R.f.mod.AR.min.decade.shape")
R.f.mod.AR.min.decade.stress <- readRDS("models/R.f.mod.AR.min.decade.stress")
R.f.mod.AR.min.decade.stress.shape <- readRDS("models/R.f.mod.AR.min.decade.stress.shape")
# overall stress?
compareML(R.f.mod.AR, R.f.mod.AR.min.stress, suggest.report=T) # sig
# shape change?
compareML(R.f.mod.AR, R.f.mod.AR.min.decade.shape, suggest.report=T) # sig
# overall stress x decade?
compareML(R.f.mod.AR, R.f.mod.AR.min.decade.stress, suggest.report=T) # sig
# shape stress x decade?
compareML(R.f.mod.AR, R.f.mod.AR.min.decade.stress.shape) # sig
```

# 4.2: Changes to coda /r/ -- Take 1: Auditory results

First, we fit our model of dynamic F3 measurements as a function of /r/-realisation, whose predictions are plotted in figure 3.

Model summary for /r/-realisation GAMM in 4.2 is in this code chunk.

```{r}

if (refit_please) {

  # model without AR
  system.time(
    R.shapes.mod.no.AR <- bam(f3 ~ stress + trans.broad.fact + gender +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(measurement.no, by=trans.broad.fact) +
                          s(measurement.no, by=gender) +
                       # level 2: 2d smooths
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R)
  )
  #saveRDS(R.shapes.mod.no.AR, "models/R.shapes.mod.no.AR")
  
  # extracting empirical autocorrelation value at lag 1
  R.shapes.rho <- start_value_rho(R.shapes.mod.no.AR)
  # setting up start.event for use with AR1
  R$start.event <- R$measurement.no == 0
  
  # full model with AR
  system.time(
    R.shapes.mod.AR   <- bam(f3 ~ stress + trans.broad.fact + gender +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(measurement.no, by=trans.broad.fact) +
                          s(measurement.no, by=gender) +
                       # level 2: 2d smooths
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R,
                      AR.start=R$start.event, rho=R.shapes.rho,
                      method="ML")
  )
  #saveRDS(R.shapes.mod.AR, "models/R.shapes.mod.AR")
  
  # nested model
  system.time(
    R.shapes.mod.AR.min.trans   <- bam(f3 ~ stress + gender + # trans.broad.fact + 
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(measurement.no, by=trans.broad.fact) +
                          s(measurement.no, by=gender) +
                       # level 2: 2d smooths
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R,
                      AR.start=R$start.event, rho=R.shapes.rho,
                      method="ML")
  )
  #saveRDS(R.shapes.mod.AR.min.trans, "models/R.shapes.mod.AR.min.trans")
}

R.shapes.mod.AR <- readRDS("models/R.shapes.mod.AR")
R.shapes.mod.AR.min.trans <- readRDS("models/R.shapes.mod.AR.min.trans")

summary(R.shapes.mod.AR)

compareML(R.shapes.mod.AR, R.shapes.mod.AR.min.trans)
```

We now run the logistic regression models whose results are reported in section 4.2 of the paper.

This code chunk also includes full summaries for these models.

```{r}
# creating a strength of /r/ variable and a presence of /r/ variable (both binary)
R.aud <- mutate(R.aud, r.strength=recode(trans.broad, 
                                    t="strong",
                                    a="strong",
                                    r="strong",
                                    wt="weak",
                                    i="weak",
                                    o="weak"),
                       r.presence=recode(trans.broad, 
                                    t="present",
                                    a="present",
                                    r="present",
                                    wt="present",
                                    i="deleted",
                                    o="deleted") 
                )
R.aud$r.strength <- factor(R.aud$r.strength, levels=c("weak","strong"))
R.aud$r.presence <- factor(R.aud$r.presence, levels=c("deleted","present"))

if (refit_please) {
  # note the absence of random slopes over decade by word (not possible to include due to non-convergence)
  # full model for strength
  r.str.mod <- glmer(r.strength ~ scale(decade) * gender + stress +
                                (1 | speaker) +
                                (1 | word),
                        data=R.aud,
                        family="binomial")
  #saveRDS(r.str.mod, "models/r.str.mod")
  
  # nested model for strength
  r.str.mod.min.decade <- glmer(r.strength ~ gender + stress +
                                (1 | speaker) +
                                (1 | word),
                        data=R.aud,
                        family="binomial")
  #saveRDS(r.str.mod.min.decade, "models/r.str.mod.min.decade")
  
  # note the absence of random slopes over decade by word (not possible to include due to non-convergence)
  # full model for /r/ presence
  r.pres.mod <- glmer(r.presence ~ scale(decade) * gender + stress +
                                (1 | speaker) +
                                (1 | word),
                        data=R.aud,
                        family="binomial",
                        control=glmerControl(optimizer="bobyqa",
                              optCtrl=list(maxfun=2e5)))
  #saveRDS(r.pres.mod, "models/r.pres.mod")
  
  # nested model for /r/ presence
  r.pres.mod.min.decade <- glmer(r.presence ~ gender + stress +
                                (1 | speaker) +
                                (1 | word),
                        data=R.aud,
                        family="binomial")
  #saveRDS(r.pres.mod.min.decade, "models/r.pres.mod.min.decade")
}

r.str.mod <- readRDS("models/r.str.mod")
r.str.mod.min.decade <- readRDS("models/r.str.mod.min.decade")
r.pres.mod <- readRDS("models/r.pres.mod")
r.pres.mod.min.decade <- readRDS("models/r.pres.mod.min.decade")

summary(r.str.mod)
summary(r.pres.mod)

# model comparisons reported in paper
anova(r.str.mod, r.str.mod.min.decade,test="Chisq")
anova(r.pres.mod, r.pres.mod.min.decade,test="Chisq")
```


# 5.1 Acoustic results for voice quality

First some plots showing the raw data for F1/F2/F3 broken down by vowels (these are especially useful as they show that all vowels show a rise in F3.

```{r}
ggplot(vowels, aes(x=decade.fact, y=f1)) +
  facet_grid(gender ~ vowel) +
  geom_boxplot()
ggplot(vowels, aes(x=decade.fact, y=f2)) +
  facet_grid(gender ~ vowel) +
  geom_boxplot()
ggplot(vowels, aes(x=decade.fact, y=f3)) +
  facet_grid(gender ~ vowel) +
  geom_boxplot()
```

## Modelling F1/F2/F3

We'll fit linear mixed models to F1/F2/F3, running the models in separate R-markdown chunks.

First F1 (including model summary):

```{r, cache=T}
# this is the model that we would like to have - but it
# does not converge due to a singularity involving 
# the decade by vowel random slope

# f1.mod.full <- lmer(f1 ~ gender * decade.fact +
#                           scale(duration) +
#                             (1 + decade.fact | vowel) +
#                             (1 | Target.orthography) +
#                             (1 | Speaker),
#               data=vowels, REML=F)

# these are two alternative models; model 1 forces the decade
# effect to be linear

if (refit_please) {
  f1.mod.full.1 <- lmer(f1 ~ gender * scale(decade) + 
                           scale(duration) +
                               (1 + scale(decade) | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f1.mod.full.1, "models/f1.mod.full.1")
  
  # model 2 has no by-vowel random slope for decade (but the decade
  # effect is allowed to be non-linear)
  
  f1.mod.full.2 <- lmer(f1 ~ gender * decade.fact + 
                           scale(duration) +
                               (1 | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f1.mod.full.2, "models/f1.mod.full.2")
  
  # neither model shows a significant effect of decade:
  # (and note that model 2 is expected to be anti-conservative with
  #  respect to decade!)
  
  f1.mod.comp.1 <- lmer(f1 ~ gender + scale(duration) +
                               (1 + scale(decade) | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f1.mod.comp.1, "models/f1.mod.comp.1")
  f1.mod.comp.2 <- lmer(f1 ~ gender + scale(duration) +
                               (1 | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f1.mod.comp.2, "models/f1.mod.comp.2")
}

f1.mod.full.1 <- readRDS("models/f1.mod.full.1")
f1.mod.full.2 <- readRDS("models/f1.mod.full.2")
f1.mod.comp.1 <- readRDS("models/f1.mod.comp.1")
f1.mod.comp.2 <- readRDS("models/f1.mod.comp.2")

anova(f1.mod.full.1, f1.mod.comp.1) # non-sig
anova(f1.mod.full.2, f1.mod.comp.2) # non-sig

summary(f1.mod.full.2)
```

F1 does not show a significant change.

```{r, cache=T}
# this is the model that we would like to have - but it
# does not converge due to a singularity involving 
# the decade by vowel random slope

# f2.mod.full <- lmer(f2 ~ gender * decade.fact +
#                           scale(duration) +
#                             (1 + decade.fact | vowel) +
#                             (1 | Target.orthography) +
#                             (1 | Speaker),
#               data=vowels, REML=F)

# these are two alternative models; model 1 forces the decade
# effect to be linear

if (refit_please) {
  f2.mod.full.1 <- lmer(f2 ~ gender * scale(decade) + 
                           scale(duration) +
                               (1 + scale(decade) | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f2.mod.full.1, "models/f2.mod.full.1")
  
  # model 2 has no by-vowel random slope for decade (but the decade
  # effect is allowed to be non-linear)
  
  f2.mod.full.2 <- lmer(f2 ~ gender * decade.fact + 
                           scale(duration) +
                               (1 | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f2.mod.full.2, "models/f2.mod.full.2")
  
  # neither model shows a significant effect of decade:
  # (and note that model 2 is expected to be anti-conservative with
  #  respect to decade!)
  
  f2.mod.comp.1 <- lmer(f2 ~ gender + scale(duration) +
                               (1 + scale(decade) | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f2.mod.comp.1, "models/f2.mod.comp.1")
  f2.mod.comp.2 <- lmer(f2 ~ gender + scale(duration) +
                               (1 | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f2.mod.comp.2, "models/f2.mod.comp.2")
}

f2.mod.full.1 <- readRDS("models/f2.mod.full.1")
f2.mod.comp.1 <- readRDS("models/f2.mod.comp.1")
f2.mod.full.2 <- readRDS("models/f2.mod.full.2")
f2.mod.comp.2 <- readRDS("models/f2.mod.comp.2")

anova(f2.mod.full.1, f2.mod.comp.1) # non-sig
anova(f2.mod.full.2, f2.mod.comp.2) # non-sig

summary(f1.mod.full.2)
```

F2 does not show a significant change.

Now for F3:

```{r}
if (refit_please) {
  f3.mod.full <- lmer(f3 ~ gender * decade.fact + 
                           scale(duration) +
                               (1 + decade.fact | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f3.mod.full, "models/f3.mod.full")
  #summary(f3.mod.full)
  
  
  f3.mod.comp <- lmer(f3 ~ gender + scale(duration) +
                               (1 + decade.fact | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f3.mod.comp, "models/f3.mod.comp")
}

f3.mod.full <- readRDS("models/f3.mod.full")
f3.mod.comp <- readRDS("models/f3.mod.comp")

anova(f3.mod.full, f3.mod.comp)

summary(f3.mod.full)
```

# 5.2 Auditory results for voice quality

We first fit a model that shows how F3 correlates with different auditory measures (includes model summary):

```{r}
vq.f3.model <- lm(avg.f3 ~ advanced.tip.blade + 
             tongue.body.height + 
             tongue.body.front.backness + 
             gender, data=R.vq)
summary(vq.f3.model)
```

We then fit three separate models (with decade centred and gender sum coded) to check for decade / gender effects in our three auditory measures (code chunk includes model summaries).

```{r}
# centring decade
R.vq$decade.centred <- scale(R.vq$decade, scale=F)
# sum coding gender
R.vq$gender.sum <- R.vq$gender
contrasts(R.vq$gender.sum) <- contr.sum(2)

# fitting and summarising models
summary(lm(tongue.body.height ~ decade.centred + gender.sum, data=R.vq))
summary(lm(tongue.body.front.backness ~ decade.centred + gender.sum, data=R.vq))
summary(lm(advanced.tip.blade ~ decade.centred + gender.sum, data=R.vq))
```

# 6. Changes to Coda R: take 2 -- acoustic analysis

## Males, take 2 (with baseline control)

Same modelling strategy as above. Model summary included in code chunk.

```{r}
if (refit_please) {
  # model without AR
  system.time(
    R.m.baseline.mod.no.AR <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m)
  )
  # saveRDS(R.m.baseline.mod.no.AR, "models/R.m.baseline.mod.no.AR")
  
  # extracting empirical autocorrelation values at lag 1
  R.m.baseline.rho <- start_value_rho(R.m.baseline.mod.no.AR)
  
  # full model with AR
  system.time(
    R.m.baseline.mod.AR <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.baseline.rho)
  )
  # saveRDS(R.m.baseline.mod.AR, "models/R.m.baseline.mod.AR")
  
  # nested model
  system.time(
    R.m.baseline.mod.AR.min.decade <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          #s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.baseline.rho)
  )
# saveRDS(R.m.baseline.mod.AR.min.decade, "models/R.m.baseline.mod.AR.min.decade")
}

R.m.baseline.mod.AR <- readRDS("models/R.m.baseline.mod.AR")
R.m.baseline.mod.AR.min.decade <- readRDS("models/R.m.baseline.mod.AR.min.decade")

summary(R.m.baseline.mod.AR)

compareML(R.m.baseline.mod.AR, R.m.baseline.mod.AR.min.decade)
```

## Females, take 2 (with baseline control)

Same modelling strategy as above. Model summary included in code chunk.

```{r}
if (refit_please) {
  # model without AR
  system.time(
    R.f.baseline.mod.no.AR <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f)
  )
  # saveRDS(R.f.baseline.mod.no.AR, "models/R.f.baseline.mod.no.AR")
  
  # extracting empirical autocorrelation value at lag 1
  R.f.baseline.rho <- start_value_rho(R.f.baseline.mod.no.AR)
  
  # full model with AR
  system.time(
    R.f.baseline.mod.AR <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.baseline.rho)
  )
  # saveRDS(R.f.baseline.mod.AR, "models/R.f.baseline.mod.AR")
  
  # nested model
  system.time(
    R.f.baseline.mod.AR.min.decade <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          #s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.baseline.rho)
  )
  # saveRDS(R.f.baseline.mod.AR.min.decade, "models/R.f.baseline.mod.AR.min.decade")
}

R.f.baseline.mod.AR <- readRDS("models/R.f.baseline.mod.AR")
R.f.baseline.mod.AR.min.decade <- readRDS("models/R.f.baseline.mod.AR.min.decade")

summary(R.f.baseline.mod.AR)

compareML(R.f.baseline.mod.AR, R.f.baseline.mod.AR.min.decade)
```
