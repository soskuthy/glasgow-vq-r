---
title: Analyses for `Voice quality and coda /r/ in Glasgow English in the early 20th
  century'
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

This R-markdown file presents all analyses for our paper titled "Voice quality and coda /r/ in Glasgow English in the early 20th century". The analyses are presented in the same order as they are in the paper, and the section numbering also follows our paper (which means that it actually starts at 4.1, which is the first results section in the paper).

We start by importing all relevant libraries and the data. The details of the data processing (e.g. exclusion of outliers) are shown in a separate file titled *data_prep.Rmd*.

Let's import the data and relevant libraries first. Note that we have saved our statistical models as RDS files, which allows the user to save time by not having to refit them (some of our generalised additive mixed models may take between 10 minutes to an hour to fit). The user has the option of re-fitting all models by changing the value of the *refit_please* variable to TRUE below.

```{r}
library(lme4)
library(mgcv)
library(itsadug)
library(rms)
library(tidyverse)
library(stringr)
library(effects)
library(here)
library(afex)

refit_please <- F # please don't refit all the models - just load them from RDS files

# vowel data
vowels <- read_csv("data/vowels.csv")
# formatting for mixed effects models
vowels$Speaker <- as.factor(vowels$Speaker)
vowels$Target.orthography <- as.factor(vowels$Target.orthography)
vowels$vowel <- as.factor(vowels$vowel)
vowels$decade <- ifelse(vowels$decade=="00", 2000, as.numeric(vowels$decade) + 1900)
vowels$decade.fact <- factor(vowels$decade.fact, levels=c("70","80","90","00"))


# /r/ data

R <- read_csv("data/R.csv") # F/M confuse read_csv...
coltyps <- spec(R)
coltyps$cols$gender <- col_character()
# and again!
R <- read_csv("data/R.csv", col_types=coltyps)

# some changes to variables to make them work with GAMMs
R <- R %>%
  mutate(stress = as.ordered(stress),
         start.event = (measurement.no==0),
         foll.broad.f3 = as.factor(foll.broad.f3),
         speaker = as.factor(speaker),
         word = as.factor(word))
contrasts(R$stress) <- "contr.treatment"

# separate data sets for males and females
R.m <- R %>%
  filter(gender=="M")
R.f <- R %>%
  filter(gender=="F")

# setting up variables for analysis via GAMMs
R$trans.broad <- recode(R$trans, wa="a")
R$trans.broad.fact <- as.ordered(R$trans.broad)
contrasts(R$trans.broad.fact) <- "contr.treatment"
R$gender.ordered <- as.ordered(R$gender)
contrasts(R$gender.ordered) <- "contr.treatment"


# auditory R data -- create data set with unique realisations
R.aud <- R[!(R$trans %in% c("", "?r")) & R$measurement.no==0,]
# only a few weakened approximants, so fold these into other categories
R.aud <- R %>%
  filter(!(trans %in% c("", "?r")), 
         !is.na(trans),
         measurement.no==0) %>%
  mutate(trans.broad=recode(trans, wa="a"),
         gender=recode(gender, M="male", `F`="female"))

# auditory voice quality data
# getting f3 avgs
avg.f3 <- unique(select(R, speaker, avg.f3))
# reading & formatting data
R.vq <- read_csv("data/auditoryvq.csv") %>%
  rename(speaker="speaker code",
         advanced.tip.blade="advanced tip/blade",
         tongue.body.height="tongue body height",
         tongue.body.front.backness="tongue body front-backness") %>%
  # join with avg.f3!
  inner_join(avg.f3, by="speaker") %>%
  mutate(gender=as.factor(ifelse(!is.na(str_match(speaker, "-m0")), "male", "female")),
         decade=unlist(substr(speaker, 1, 2)),
         decade=as.numeric(recode(decade, `00`="100")) + 1900)

```

# 4.1: Changes to coda /r/ -- Take 1: Acoustic results

## Males without baseline control

Analysing males first, not controlling for baseline F3. Fitting three models:

- model without AR for estimating rho (so that autocorrelation can be handled correctly)
- full model with AR
- nested model with AR (rho from full model)

```{r}
if (refit_please) {
  # model without AR
  system.time(
    R.m.mod.no.AR <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m)
  )
  # saveRDS(R.m.mod.no.AR, "models/R.m.mod.no.AR")
  
  # extracting empirical value of autocorrelation at lag 1
  R.m.rho <- start_value_rho(R.m.mod.no.AR)
  
  # full model with AR
  system.time(
    R.m.mod.AR <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
  # saveRDS(R.m.mod.AR, "models/R.m.mod.AR")
  
  summary(R.m.mod.AR)
  
  # nested model with AR
  system.time(
    R.m.mod.AR.min.decade <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          #s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
# saveRDS(R.m.mod.AR.min.decade, "models/R.m.mod.AR.min.decade")
}

R.m.mod.AR <- readRDS("models/R.m.mod.AR")
R.m.mod.AR.min.decade <- readRDS("models/R.m.mod.AR.min.decade")

compareML(R.m.mod.AR, R.m.mod.AR.min.decade) # significant overall effect of decade
```

Further questions (only first two of these discussed in paper):

- overall effect of stress?
- significant change in shape?
- do unstressed / stressed syllables show different changes?
  - different shape change?
  - different overall change?

```{r}
if (refit_please) {

  # overall stress?

  system.time(
    R.m.mod.AR.min.stress <- bam(f3 ~ #stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          #s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
  # saveRDS(R.m.mod.AR.min.stress, "models/R.m.mod.AR.min.stress")

  # shape change?

  system.time(
    R.m.mod.AR.min.decade.shape <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
  # saveRDS(R.m.mod.AR.min.decade.shape, "models/R.m.mod.AR.min.decade.shape")

  # overall stress x decade?

  system.time(
    R.m.mod.AR.min.decade.stress <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
  # saveRDS(R.m.mod.AR.min.decade.stress, "models/R.m.mod.AR.min.decade.stress")
  
  # shape stress x decade?
  
  system.time(
    R.m.mod.AR.min.decade.stress.shape <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.rho)
  )
  # saveRDS(R.m.mod.AR.min.decade.stress.shape, "models/R.m.mod.AR.min.decade.stress.shape")
}
  

R.m.mod.AR.min.stress <- readRDS("models/R.m.mod.AR.min.stress")
R.m.mod.AR.min.decade.shape <- readRDS("models/R.m.mod.AR.min.decade.shape")
R.m.mod.AR.min.decade.stress <- readRDS("models/R.m.mod.AR.min.decade.stress")
R.m.mod.AR.min.decade.stress.shape <- readRDS("models/R.m.mod.AR.min.decade.stress.shape")
# overall stress?
compareML(R.m.mod.AR, R.m.mod.AR.min.stress, suggest.report=T) # non-sig
# shape change?
compareML(R.m.mod.AR, R.m.mod.AR.min.decade.shape, suggest.report=T) # non-sig
# overall stress x decade?
compareML(R.m.mod.AR, R.m.mod.AR.min.decade.stress, suggest.report=T) # non-sig
# shape stress x decade?
compareML(R.m.mod.AR, R.m.mod.AR.min.decade.stress.shape) # non-sig
```

Creating figure 2 bottom panel showing the model predictions for males.

```{r}
# extracting model predictions (using plot_smooth from itsadug)
R.m.full.plot <- plot_smooth(R.m.mod.AR, view="measurement.no", plot_all="decade", 
            cond=list(stress="full"), rm.ranef=T, n.grid=100)$fv
R.m.schwa.plot <- plot_smooth(R.m.mod.AR, view="measurement.no", plot_all="decade", 
            cond=list(stress="schwa"), rm.ranef=T, n.grid=100)$fv
R.m.plot <- rbind(R.m.full.plot, R.m.schwa.plot)

# formatting decade predictor
R.m.plot$decade <- factor(R.m.plot$decade, levels=c("1970","1980","1990","2000"))

# creating the plot
ggplot(R.m.plot, aes(x=measurement.no, y=fit, group=decade, col=decade, lty=decade)) +
  geom_line(lwd=1) +
  facet_grid(.~stress) +
  geom_ribbon(aes(ymin=ll, ymax=ul, group=decade), col=NA,col="grey", alpha=0.1) +
  scale_color_manual(values=c("orange","darkorange3","deepskyblue1","deepskyblue4"),
                     name="decade of\nrecording") +
  scale_linetype_discrete(name="decade of\nrecording") +
  scale_x_continuous(name="measurement point", limits = c(0, 10), breaks=seq(0,10,2)) +
  scale_y_continuous(name="F3 (Hz)", limits=c(2000, 3050)) +
  theme_bw() +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=12),
        legend.title = element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        plot.title=element_text(size=14, face="bold"),
        panel.grid=element_blank(),
        strip.text=element_text(size=12)) +
  ggtitle("F3 changes for /r/ in males (not controlling for baseline F3)")
#ggsave("graphs/r_male_f3_change_no_control.pdf", width=8, height=4)
```



## Females without baseline control

Analysing females, not controlling for baseline F3. Fitting three models:

- model without AR for estimating rho (so that autocorrelation can be handled correctly)
- full model with AR
- nested model with AR (rho from full model)

```{r}
if (refit_please) {
  # model without AR
  system.time(
    R.f.mod.no.AR <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f)
  )
  # saveRDS(R.f.mod.no.AR, "models/R.f.mod.no.AR")
  
  # extracting empirical value of autocorrelation at lag 1
  R.f.rho <- start_value_rho(R.f.mod.no.AR)
  
  # full model with AR
  system.time(
    R.f.mod.AR <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR, "models/R.f.mod.AR")
  
  summary(R.f.mod.AR)
  
  # nested model with AR
  system.time(
    R.f.mod.AR.min.decade <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          #s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR.min.decade, "models/R.f.mod.AR.min.decade")
}

R.f.mod.AR <- readRDS("models/R.f.mod.AR")
R.f.mod.AR.min.decade <- readRDS("models/R.f.mod.AR.min.decade")

compareML(R.f.mod.AR, R.f.mod.AR.min.decade) # significant overall effect of decade
```

Further questions (only first two of these discussed in paper):

- overall effect of stress?
- significant change in shape?
- do unstressed / stressed syllables show different changes?
  - different shape change?
  - different overall change?

```{r}
if (refit_please) {

  # overall stress?

  system.time(
    R.f.mod.AR.min.stress <- bam(f3 ~ #stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          #s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR.min.stress, "models/R.f.mod.AR.min.stress")

  # shape change?

  system.time(
    R.f.mod.AR.min.decade.shape <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR.min.decade.shape, "models/R.f.mod.AR.min.decade.shape")

  # overall stress x decade?

  system.time(
    R.f.mod.AR.min.decade.stress <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR.min.decade.stress, "models/R.f.mod.AR.min.decade.stress")
  
  # shape stress x decade?
  
  system.time(
    R.f.mod.AR.min.decade.stress.shape <- bam(f3 ~ stress +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.rho)
  )
  # saveRDS(R.f.mod.AR.min.decade.stress.shape, "models/R.f.mod.AR.min.decade.stress.shape")
}
  

R.f.mod.AR.min.stress <- readRDS("models/R.f.mod.AR.min.stress")
R.f.mod.AR.min.decade.shape <- readRDS("models/R.f.mod.AR.min.decade.shape")
R.f.mod.AR.min.decade.stress <- readRDS("models/R.f.mod.AR.min.decade.stress")
R.f.mod.AR.min.decade.stress.shape <- readRDS("models/R.f.mod.AR.min.decade.stress.shape")
# overall stress?
compareML(R.f.mod.AR, R.f.mod.AR.min.stress, suggest.report=T) # sig
# shape change?
compareML(R.f.mod.AR, R.f.mod.AR.min.decade.shape, suggest.report=T) # sig
# overall stress x decade?
compareML(R.f.mod.AR, R.f.mod.AR.min.decade.stress, suggest.report=T) # sig
# shape stress x decade?
compareML(R.f.mod.AR, R.f.mod.AR.min.decade.stress.shape) # sig
```

Creating figure 2 top panel showing the model predictions for females.

```{r}
# extracting model predictions (using plot_smooth from itsadug)
R.f.full.plot <- plot_smooth(R.f.mod.AR, view="measurement.no", plot_all="decade", 
            cond=list(stress="full"), rm.ranef=T, n.grid=100)$fv
R.f.schwa.plot <- plot_smooth(R.f.mod.AR, view="measurement.no", plot_all="decade", 
            cond=list(stress="schwa"), rm.ranef=T, n.grid=100)$fv
R.f.plot <- rbind(R.f.full.plot, R.f.schwa.plot)

# formatting decade predictor
R.f.plot$decade <- factor(R.f.plot$decade, levels=c("1970","1980","1990","2000"))
  
# creating plot
ggplot(R.f.plot, aes(x=measurement.no, y=fit, group=decade, col=decade, lty=decade)) +
  geom_line(lwd=1) +
  facet_grid(.~stress) +
  geom_ribbon(aes(ymin=ll, ymax=ul, group=decade), col=NA,col="grey", alpha=0.1) +
  scale_color_manual(name="decade of\nrecording", values=c("orange","darkorange3","deepskyblue1","deepskyblue4")) +
  scale_linetype_discrete(name="decade of\nrecording") +
  scale_x_continuous(name="measurement point", limits = c(0, 10), breaks=seq(0,10,2)) +
  scale_y_continuous(name="F3 (Hz)", limits=c(2000, 3050)) +
  theme_bw() +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=12),
        legend.title = element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        plot.title=element_text(size=14, face="bold"),
        panel.grid=element_blank(),
        strip.text=element_text(size=12)) +
  ggtitle("F3 changes for /r/ in females (not controlling for baseline F3)")
#ggsave("graphs/r_female_f3_change_no_control.pdf", width=8, height=4)
```


# 4.2: Changes to coda /r/ -- Take 1: Auditory results

First, we fit our model of dynamic F3 measurements as a function of /r/-realisation, whose predictions are plotted in figure 3.

```{r}

if (refit_please) {

  # model without AR
  system.time(
    R.shapes.mod.no.AR <- bam(f3 ~ stress + trans.broad.fact + gender +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(measurement.no, by=trans.broad.fact) +
                          s(measurement.no, by=gender) +
                       # level 2: 2d smooths
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R)
  )
  #saveRDS(R.shapes.mod.no.AR, "models/R.shapes.mod.no.AR")
  
  # extracting empirical autocorrelation value at lag 1
  R.shapes.rho <- start_value_rho(R.shapes.mod.no.AR)
  # setting up start.event for use with AR1
  R$start.event <- R$measurement.no == 0
  
  # full model with AR
  system.time(
    R.shapes.mod.AR   <- bam(f3 ~ stress + trans.broad.fact + gender +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(measurement.no, by=trans.broad.fact) +
                          s(measurement.no, by=gender) +
                       # level 2: 2d smooths
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R,
                      AR.start=R$start.event, rho=R.shapes.rho,
                      method="ML")
  )
  #saveRDS(R.shapes.mod.AR, "models/R.shapes.mod.AR")
  
  summary(R.shapes.mod.AR)
  
  # nested model
  system.time(
    R.shapes.mod.AR.min.trans   <- bam(f3 ~ stress + gender + # trans.broad.fact + 
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(measurement.no, by=trans.broad.fact) +
                          s(measurement.no, by=gender) +
                       # level 2: 2d smooths
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R,
                      AR.start=R$start.event, rho=R.shapes.rho,
                      method="ML")
  )
  #saveRDS(R.shapes.mod.AR.min.trans, "models/R.shapes.mod.AR.min.trans")
}

R.shapes.mod.AR <- readRDS("models/R.shapes.mod.AR")
R.shapes.mod.AR.min.trans <- readRDS("models/R.shapes.mod.AR.min.trans")

compareML(R.shapes.mod.AR, R.shapes.mod.AR.min.trans)
```

Now creating figure 3.

```{r}
# extracting model predictions
R.shapes <- plot_smooth(R.shapes.mod.AR, view="measurement.no", plot_all="trans.broad.fact",
                        cond=list(gender="F"), rm.ranef=T, rug=F)[[1]]

# releveling, meaningful names for realisations
R.shapes$trans.broad.fact <- factor(R.shapes$trans.broad.fact, levels=c("o","i","wt","a","t","r"))
R.shapes <- R.shapes %>% 
  mutate(realisation=recode(trans.broad.fact,
                            o="zero",
                            i="intermediate",
                            wt="weakened tap",
                            a="approximant",
                            t="full tap",
                            r="trill"),
         realisation=factor(realisation, 
                            levels=c("zero",
                                     "intermediate",
                                     "weakened tap",
                                     "approximant",
                                     "full tap",
                                     "trill"))
  )
# excluding trills
R.shapes <- filter(R.shapes, trans.broad.fact != "r")

# creating graph
ggplot(R.shapes, aes(x=measurement.no, y=fit, col=realisation, lty=realisation)) +
  geom_ribbon(aes(ymin=ll, ymax=ul, group=trans.broad.fact), alpha=0.05, colour=NA) +
  geom_line(lwd=1) +
  scale_linetype_manual(values = c(3,4,2,
                              5,1),
                     name="/r/ realisation") +
  scale_colour_manual(values = c("orange","darkorange1",
                               "darkorange3","deepskyblue1",
                               "deepskyblue3"),
                      name="/r/ realisation") +
  scale_x_continuous(name="measurement point", limits = c(0, 10), breaks=seq(0,10,2)) +
  scale_y_continuous(name="F3 (Hz)", limits=c(2450,2950)) +
  theme_bw() +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=12),
        legend.title = element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        plot.title=element_text(size=14, face="bold"),
        panel.grid=element_blank(),
        strip.text=element_text(size=12)) +
  ggtitle("Acoustic correlates of different /r/ realisations in F3")
#ggsave("graphs/r_acoustic_correlates.pdf", width=6, height=4)
```

We now create figure 4, that is, the proportions of different realisations as a function of time.

```{r}
# calculating proportions
R.props.dec <- R.aud %>% 
  count(decade, gender, trans.broad) %>% 
  group_by(decade, gender) %>%
  mutate(prop = n/sum(n)) %>%
  ungroup()

# releveling
R.props.dec$trans.broad <- factor(R.props.dec$trans.broad, levels=c("o","i","wt","a","t","r"))

# creating the graph
ggplot(R.props.dec, aes(x=decade, fill=trans.broad)) + 
  geom_bar(aes(y=prop), stat="identity", position="stack") + 
  facet_wrap(~gender) + 
  scale_fill_manual(values = c("orange","darkorange1",
                               "darkorange3","deepskyblue1",
                               "deepskyblue3","deepskyblue4"),
                     name="/r/ realisation", 
                    labels=c("zero","intermediate",
                             "weakened tap","approximant",
                             "tap","trill")) +
  scale_y_continuous(labels = scales::percent, name="percentage of realisations") +
  scale_x_continuous(name = "decade of recording") +
  theme_bw() +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=12),
        legend.title = element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        plot.title=element_text(size=14, face="bold"),
        panel.grid=element_blank(),
        strip.text=element_text(size=12)) +
ggtitle("Changes in proportions of auditory /r/ variants")
#ggsave("graphs/r_auditory.pdf", width=8, height=4)
```

We now run the logistic regression models whose results are reported in section 4.2 of the paper.

```{r}
# creating a strength of /r/ variable and a presence of /r/ variable (both binary)
R.aud <- mutate(R.aud, r.strength=recode(trans.broad, 
                                    t="strong",
                                    a="strong",
                                    r="strong",
                                    wt="weak",
                                    i="weak",
                                    o="weak"),
                       r.presence=recode(trans.broad, 
                                    t="present",
                                    a="present",
                                    r="present",
                                    wt="present",
                                    i="deleted",
                                    o="deleted") 
                )
R.aud$r.strength <- factor(R.aud$r.strength, levels=c("weak","strong"))
R.aud$r.presence <- factor(R.aud$r.presence, levels=c("deleted","present"))

if (refit_please) {
  # note the absence of random slopes over decade by word (not possible to include due to non-convergence)
  # full model for strength
  r.str.mod <- glmer(r.strength ~ scale(decade) * gender + stress +
                                (1 | speaker) +
                                (1 | word),
                        data=R.aud,
                        family="binomial")
  #saveRDS(r.str.mod, "models/r.str.mod")
  
  # nested model for strength
  r.str.mod.min.decade <- glmer(r.strength ~ gender + stress +
                                (1 | speaker) +
                                (1 | word),
                        data=R.aud,
                        family="binomial")
  #saveRDS(r.str.mod.min.decade, "models/r.str.mod.min.decade")
  
  # note the absence of random slopes over decade by word (not possible to include due to non-convergence)
  # full model for /r/ presence
  r.pres.mod <- glmer(r.presence ~ scale(decade) * gender + stress +
                                (1 | speaker) +
                                (1 | word),
                        data=R.aud,
                        family="binomial",
                        control=glmerControl(optimizer="bobyqa",
                              optCtrl=list(maxfun=2e5)))
  #saveRDS(r.pres.mod, "models/r.pres.mod")
  
  # nested model for /r/ presence
  r.pres.mod.min.decade <- glmer(r.presence ~ gender + stress +
                                (1 | speaker) +
                                (1 | word),
                        data=R.aud,
                        family="binomial")
  #saveRDS(r.pres.mod.min.decade, "models/r.pres.mod.min.decade")
}

r.str.mod <- readRDS("models/r.str.mod")
r.str.mod.min.decade <- readRDS("models/r.str.mod.min.decade")
r.pres.mod <- readRDS("models/r.pres.mod")
r.pres.mod.min.decade <- readRDS("models/r.pres.mod.min.decade")

summary(r.str.mod)
summary(r.pres.mod)

# model comparisons reported in paper
anova(r.str.mod, r.str.mod.min.decade,test="Chisq")
anova(r.pres.mod, r.pres.mod.min.decade,test="Chisq")
```


# 5.1 Acoustic results for voice quality

First some plots showing the raw data for F1/F2/F3 broken down by vowels (these are especially useful as they show that all vowels show a rise in F39.

```{r}
ggplot(vowels, aes(x=decade.fact, y=f1)) +
  facet_grid(gender ~ vowel) +
  geom_boxplot()
ggplot(vowels, aes(x=decade.fact, y=f2)) +
  facet_grid(gender ~ vowel) +
  geom_boxplot()
ggplot(vowels, aes(x=decade.fact, y=f3)) +
  facet_grid(gender ~ vowel) +
  geom_boxplot()
```

## Modelling F1/F2/F3

We'll fit linear mixed models to F1/F2/F3, running the models in separate R-markdown chunks.

First F1:

```{r, cache=T}
# this is the model that we would like to have - but it
# does not converge due to a singularity involving 
# the decade by vowel random slope

# f1.mod.full <- lmer(f1 ~ gender * decade.fact +
#                           scale(duration) +
#                             (1 + decade.fact | vowel) +
#                             (1 | Target.orthography) +
#                             (1 | Speaker),
#               data=vowels, REML=F)

# these are two alternative models; model 1 forces the decade
# effect to be linear

if (refit_please) {
  f1.mod.full.1 <- lmer(f1 ~ gender * scale(decade) + 
                           scale(duration) +
                               (1 + scale(decade) | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f1.mod.full.1, "models/f1.mod.full.1")
  
  # model 2 has no by-vowel random slope for decade (but the decade
  # effect is allowed to be non-linear)
  
  f1.mod.full.2 <- lmer(f1 ~ gender * decade.fact + 
                           scale(duration) +
                               (1 | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f1.mod.full.2, "models/f1.mod.full.2")
  
  # neither model shows a significant effect of decade:
  # (and note that model 2 is expected to be anti-conservative with
  #  respect to decade!)
  
  f1.mod.comp.1 <- lmer(f1 ~ gender + scale(duration) +
                               (1 + scale(decade) | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f1.mod.comp.1, "models/f1.mod.comp.1")
  f1.mod.comp.2 <- lmer(f1 ~ gender + scale(duration) +
                               (1 | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f1.mod.comp.2, "models/f1.mod.comp.2")
}

f1.mod.full.1 <- readRDS("models/f1.mod.full.1")
f1.mod.full.2 <- readRDS("models/f1.mod.full.2")
f1.mod.comp.1 <- readRDS("models/f1.mod.comp.1")
f1.mod.comp.2 <- readRDS("models/f1.mod.comp.2")
anova(f1.mod.full.1, f1.mod.comp.1) # non-sig
anova(f1.mod.full.2, f1.mod.comp.2) # non-sig
```

F1 does not show a significant change.

```{r, cache=T}
# this is the model that we would like to have - but it
# does not converge due to a singularity involving 
# the decade by vowel random slope

# f2.mod.full <- lmer(f2 ~ gender * decade.fact +
#                           scale(duration) +
#                             (1 + decade.fact | vowel) +
#                             (1 | Target.orthography) +
#                             (1 | Speaker),
#               data=vowels, REML=F)

# these are two alternative models; model 1 forces the decade
# effect to be linear

if (refit_please) {
  f2.mod.full.1 <- lmer(f2 ~ gender * scale(decade) + 
                           scale(duration) +
                               (1 + scale(decade) | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f2.mod.full.1, "models/f2.mod.full.1")
  
  # model 2 has no by-vowel random slope for decade (but the decade
  # effect is allowed to be non-linear)
  
  f2.mod.full.2 <- lmer(f2 ~ gender * decade.fact + 
                           scale(duration) +
                               (1 | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f2.mod.full.2, "models/f2.mod.full.2")
  
  # neither model shows a significant effect of decade:
  # (and note that model 2 is expected to be anti-conservative with
  #  respect to decade!)
  
  f2.mod.comp.1 <- lmer(f2 ~ gender + scale(duration) +
                               (1 + scale(decade) | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f2.mod.comp.1, "models/f2.mod.comp.1")
  f2.mod.comp.2 <- lmer(f2 ~ gender + scale(duration) +
                               (1 | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f2.mod.comp.2, "models/f2.mod.comp.2")
}

f2.mod.full.1 <- readRDS("models/f2.mod.full.1")
f2.mod.comp.1 <- readRDS("models/f2.mod.comp.1")
f2.mod.full.2 <- readRDS("models/f2.mod.full.2")
f2.mod.comp.2 <- readRDS("models/f2.mod.comp.2")

anova(f2.mod.full.1, f2.mod.comp.1) # non-sig
anova(f2.mod.full.2, f2.mod.comp.2) # non-sig
```

F2 does not show a significant change.

Now for F3:

```{r}
if (refit_please) {
  f3.mod.full <- lmer(f3 ~ gender * decade.fact + 
                           scale(duration) +
                               (1 + decade.fact | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f3.mod.full, "models/f3.mod.full")
  #summary(f3.mod.full)
  
  
  f3.mod.comp <- lmer(f3 ~ gender + scale(duration) +
                               (1 + decade.fact | vowel) +
                               (1 | Target.orthography) +
                               (1 | Speaker),
                 data=vowels, REML=F)
  # saveRDS(f3.mod.comp, "models/f3.mod.comp")
}

f3.mod.full <- readRDS("models/f3.mod.full")
f3.mod.comp <- readRDS("models/f3.mod.comp")

anova(f3.mod.full, f3.mod.comp)
```

F3 clearly rises significantly over time. Prediction plot for the paper, i.e. figure 5:

```{r}
# extracting predictions from the model
new.dat <- expand.grid(gender=unique(vowels$gender),
                       decade.fact=levels(vowels$decade.fact),
                       duration=median(vowels$duration),
                       vowel=unique(vowels$vowel)[1])
new.dat$f3 <- 0
new.dat$f3 <- predict(f3.mod.full, new.dat, re.form=NA)
mm <- model.matrix(terms(f3.mod.full),new.dat) # for confidence intervals
pvar1 <- diag(mm %*% tcrossprod(vcov(f3.mod.full),mm))

new.dat <- data.frame(
    new.dat,
    lower = new.dat$f3-2*sqrt(pvar1),
    upper = new.dat$f3+2*sqrt(pvar1)
)

# creating the graph

mean_fun <- function(x){
  return(data.frame(y = mean(x), label = paste0("  ", round(mean(x)), " Hz")))
}

ggplot(new.dat, aes(x=decade.fact, y=f3, col=gender)) +
  geom_violin(data=vowels, aes(fill=gender, col=NA), alpha=0.2, show.legend=F) +
  geom_point(size=2, position=position_dodge(width=0.9)) +
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.25, position=position_dodge(width=0.9)) +
  stat_summary(fun.data = mean_fun, geom = "text", size=4, position=position_dodge(0.9), hjust=0, show.legend=F) +
  scale_color_manual(name="gender",breaks=c("F","M"), labels=c("female", "male"), 
                     values=c("deepskyblue4","orange")) +
  scale_fill_manual(name="gender",breaks=c("F","M"), labels=c("female", "male"), 
                     values=c("deepskyblue4","orange"), guide=F) +
  scale_x_discrete(name="decade of recording", labels=c(1970,1980,1990,2000), expand=expand_scale(add=c(0.05,1))) +
  scale_y_continuous(name="F3") +
  theme_bw() +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=12),
        legend.title = element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        plot.title=element_text(size=14, face="bold"),
        panel.grid=element_blank()) +
  ggtitle("F3 changes for vowels (with model predictions)")
#ggsave("graphs/vowels_f3_change.pdf", width=8, height=4)
  
```


# 5.2 Auditory results for voice quality

We first fit a model that shows how F3 correlates with different auditory measures

```{r}
vq.f3.model <- lm(avg.f3 ~ advanced.tip.blade + 
             tongue.body.height + 
             tongue.body.front.backness + 
             gender, data=R.vq)
summary(vq.f3.model)
```

We then fit three separate models (with decade centred and gender sum coded) to check for decade / gender effects in our three auditory measures.

```{r}
# centring decade
R.vq$decade.centred <- scale(R.vq$decade, scale=F)
# sum coding gender
R.vq$gender.sum <- R.vq$gender
contrasts(R.vq$gender.sum) <- contr.sum(2)

# fitting and summarising models
summary(lm(tongue.body.height ~ decade.centred + gender.sum, data=R.vq))
summary(lm(tongue.body.front.backness ~ decade.centred + gender.sum, data=R.vq))
summary(lm(advanced.tip.blade ~ decade.centred + gender.sum, data=R.vq))
```

Create figure 6.

```{r}
# getting counts of different tongue body height values per decade
R.vq.count <- dplyr::count(R.vq, tongue.body.height, decade)
# arranging by decade / tongue body height
R.vq.ordered <- R.vq %>% 
  arrange(decade, tongue.body.height)

# creating graph
ggplot(R.vq.ordered, aes(x=factor(decade), y=tongue.body.height)) +
  geom_point(x=1,y=1, aes(colour="Female")) + # this is a hack for getting the legend right 
  geom_point(x=1,y=1, aes(colour="Male")) + # this is a hack for getting the legend right 
  scale_color_manual(name="Gender", values=c("deepskyblue4","orange"), breaks=c("Female","Male")) +
  geom_dotplot(binaxis="y", stackdir="center", binpositions="all",
               fill=ifelse(R.vq.ordered$gender=="female", "deepskyblue4","orange"),
               col=NA, dotsize=1.5) +
  stat_summary(fun.y=mean, fun.ymin=mean, fun.ymax=mean, geom="crossbar", aes(group=decade), width=0.4, col="grey") +
  scale_x_discrete(name="Decade of recording") +
  scale_y_continuous(name="Tongue body height") +
  guides(colour = guide_legend(override.aes = list(size = 4))) +
  theme_bw() +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=12),
        legend.title = element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        plot.title=element_text(size=14, face="bold"),
        panel.grid=element_blank(),
        strip.text=element_text(size=12)) +
  ggtitle("Changes in tongue body height over time")
# ggsave("graphs/tongue_body_height.pdf", width=6, height=4)
```

# Changes to Coda R: take 2 -- acoustic analysis

## Males, take 2 (with baseline control)

Same modelling strategy as above.

```{r}
if (refit_please) {
  # model without AR
  system.time(
    R.m.baseline.mod.no.AR <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m)
  )
  # saveRDS(R.m.baseline.mod.no.AR, "models/R.m.baseline.mod.no.AR")
  
  # extracting empirical autocorrelation values at lag 1
  R.m.baseline.rho <- start_value_rho(R.m.baseline.mod.no.AR)
  
  # full model with AR
  system.time(
    R.m.baseline.mod.AR <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.baseline.rho)
  )
  # saveRDS(R.m.baseline.mod.AR, "models/R.m.baseline.mod.AR")
  
  summary(R.m.baseline.mod.AR)
  
  # nested model
  system.time(
    R.m.baseline.mod.AR.min.decade <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          #s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.m, method="ML",
                      AR.start=R.m$start.event, rho=R.m.baseline.rho)
  )
# saveRDS(R.m.baseline.mod.AR.min.decade, "models/R.m.baseline.mod.AR.min.decade")
}

R.m.baseline.mod.AR <- readRDS("models/R.m.baseline.mod.AR")
R.m.baseline.mod.AR.min.decade <- readRDS("models/R.m.baseline.mod.AR.min.decade")

compareML(R.m.baseline.mod.AR, R.m.baseline.mod.AR.min.decade)
```

Creating the bottom panel of figure 7.

```{r}
# extracting predictions, formatting decade
R.m.baseline.full.plot <- plot_smooth(R.m.baseline.mod.AR, view="measurement.no", plot_all="decade", 
            cond=list(stress="full"), rm.ranef=T, n.grid=100)$fv
R.m.baseline.schwa.plot <- plot_smooth(R.m.baseline.mod.AR, view="measurement.no", plot_all="decade", 
            cond=list(stress="schwa"), rm.ranef=T, n.grid=100)$fv
R.m.baseline.plot <- rbind(R.m.baseline.full.plot, R.m.baseline.schwa.plot)
R.m.baseline.plot$decade <- factor(R.m.baseline.plot$decade, levels=c("1970","1980","1990","2000"))

# create graph
ggplot(R.m.baseline.plot, aes(x=measurement.no, y=fit, group=decade, col=decade, lty=decade)) +
  geom_line(lwd=1) +
  facet_grid(.~stress) +
  geom_ribbon(aes(ymin=ll, ymax=ul, group=decade), col=NA,col="grey", alpha=0.1) +
  scale_color_manual(name="decade of\nrecording", values=c("orange","darkorange3","deepskyblue1","deepskyblue4")) +
  scale_linetype_discrete(name="decade of\nrecording") +
  scale_x_continuous(name="measurement point", limits = c(0, 10), breaks=seq(0,10,2)) +
  scale_y_continuous(name="F3 (Hz)", limits=c(2000, 3050)) +
  theme_bw() +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=12),
        legend.title = element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        plot.title=element_text(size=14, face="bold"),
        panel.grid=element_blank(),
        strip.text=element_text(size=12)) +
  ggtitle("F3 changes for /r/ in males (controlling for baseline F3)")
#ggsave("graphs/r_male_f3_change_control.pdf", width=8, height=4)
```

## Females, take 2 (with baseline control)

Same modelling strategy as above.

```{r}
if (refit_please) {
  # model without AR
  system.time(
    R.f.baseline.mod.no.AR <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f)
  )
  # saveRDS(R.f.baseline.mod.no.AR, "models/R.f.baseline.mod.no.AR")
  
  # extracting empirical autocorrelation value at lag 1
  R.f.baseline.rho <- start_value_rho(R.f.baseline.mod.no.AR)
  
  # full model with AR
  system.time(
    R.f.baseline.mod.AR <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.baseline.rho)
  )
  # saveRDS(R.f.baseline.mod.AR, "models/R.f.baseline.mod.AR")
  
  summary(R.f.baseline.mod.AR)
  
  # nested model
  system.time(
    R.f.baseline.mod.AR.min.decade <- bam(f3 ~ stress +
                          avg.f3 +
                       # level 1 smooth terms
                          s(measurement.no) +
                          #s(decade, k=4) +
                          s(duration) +
                          s(preceding.front, k=3) +
                       # level 2: by terms
                          s(measurement.no, by=stress) +
                          #s(decade, k=4, by=stress) +
                       # level 2: 2d smooths
                          #ti(measurement.no, decade, k=c(10,4)) +
                          ti(measurement.no, duration) +
                          ti(measurement.no, preceding.front, k=c(10,3)) +
                       # level 3: 2d smooth by terms
                          #ti(measurement.no, decade, k=c(10,4), by=stress) +
                       # random smooths
                          s(measurement.no, foll.broad.f3, bs="fs", m=1, k=4) +
                          s(measurement.no, speaker, bs="fs", m=1, k=4) +
                          s(measurement.no, word, bs="fs", m=1, k=4),
                      dat=R.f, method="ML",
                      AR.start=R.f$start.event, rho=R.f.baseline.rho)
  )
  # saveRDS(R.f.baseline.mod.AR.min.decade, "models/R.f.baseline.mod.AR.min.decade")
}

R.f.baseline.mod.AR <- readRDS("models/R.f.baseline.mod.AR")
R.f.baseline.mod.AR.min.decade <- readRDS("models/R.f.baseline.mod.AR.min.decade")

compareML(R.f.baseline.mod.AR, R.f.baseline.mod.AR.min.decade)
```

Creating the top panel of figure 7.

```{r}
R.f.baseline.full.plot <- plot_smooth(R.f.baseline.mod.AR, view="measurement.no", plot_all="decade", 
            cond=list(stress="full"), rm.ranef=T, n.grid=100)$fv
R.f.baseline.schwa.plot <- plot_smooth(R.f.baseline.mod.AR, view="measurement.no", plot_all="decade", 
            cond=list(stress="schwa"), rm.ranef=T, n.grid=100)$fv
R.f.baseline.plot <- rbind(R.f.baseline.full.plot, R.f.baseline.schwa.plot)
R.f.baseline.plot$decade <- factor(R.f.baseline.plot$decade, levels=c("1970","1980","1990","2000"))

# creating graph
ggplot(R.f.baseline.plot, aes(x=measurement.no, y=fit, group=decade, col=decade, lty=decade)) +
  geom_line(lwd=1) +
  facet_grid(.~stress) +
  geom_ribbon(aes(ymin=ll, ymax=ul, group=decade), col=NA,col="grey", alpha=0.1) +
  scale_color_manual(name="decade of\nrecording", values=c("orange","darkorange3","deepskyblue1","deepskyblue4")) +
  scale_linetype_discrete(name="decade of\nrecording") +
  scale_x_continuous(name="measurement point", limits = c(0, 10), breaks=seq(0,10,2)) +
  scale_y_continuous(name="F3 (Hz)", limits=c(2000, 3050)) +
  theme_bw() +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=12),
        legend.title = element_text(size=14, face="bold"),
        legend.text=element_text(size=12),
        plot.title=element_text(size=14, face="bold"),
        panel.grid=element_blank(),
        strip.text=element_text(size=12)) +
  ggtitle("F3 changes for /r/ in females (controlling for baseline F3)")
#ggsave("graphs/r_female_f3_change_control.pdf", width=8, height=4)
```





